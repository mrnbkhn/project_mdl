{"version":3,"file":"codeeditors.min.js","sources":["../src/codeeditors.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides utility methods to setup resizable ace editors into a page.\n * @copyright  Astor Bizard, 2019\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* globals ace */\ndefine(['jquery', 'core/url', 'core/config'], function($, url, cfg) {\n\n    // Global Ace editor theme and font size to use for all editors.\n    var aceTheme;\n    var fontSize;\n\n    /**\n     * Setup each specified textarea with Ace editor, with a vertical resize feature.\n     * It inherits readonly attribute from textarea.\n     * @param {jQuery} $textareas JQuery set of textareas from which to set up editors.\n     * @param {String} aceSize Initial CSS size of editors.\n     * @param {String} aceLang (optional) Lang (mode) to setup editors from.\n     * @return {Editor} The last editor set up.\n     */\n    function setupAceEditors($textareas, aceSize, aceLang) {\n        var aceEditor;\n\n        // Vertical resizing.\n        var prevY;\n        var $placeholderBeingResized = null;\n\n        if (aceLang === undefined) {\n            aceLang = 'plain_text';\n        }\n\n        $textareas.each(function() {\n            var $textarea = $(this);\n            var $editorPlaceholder = $('<div>', {\n                width: '100%',\n                height: aceSize,\n                'id': 'ace_placeholder_' + $textarea.attr('name'),\n                'class': 'ace-placeholder'\n            }).insertAfter($textarea);\n            $textarea.hide();\n\n            $('<div>', {\n                'id': 'ace_resize_' + $textarea.attr('name'),\n                'class': 'ace-resize'\n            }).insertAfter($editorPlaceholder)\n            .mousedown(function(event) {\n                prevY = event.clientY;\n                $placeholderBeingResized = $editorPlaceholder;\n                event.preventDefault();\n            });\n\n            // This is what creates the Ace editor within the placeholder div.\n            aceEditor = ace.edit($editorPlaceholder[0]);\n            aceEditor.setOptions({\n                theme: 'ace/theme/' + aceTheme,\n                mode: 'ace/mode/' + aceLang\n            });\n            aceEditor.setFontSize(fontSize);\n            aceEditor.$blockScrolling = Infinity; // Disable ace warning.\n            aceEditor.getSession().setValue($textarea.val());\n            aceEditor.setReadOnly($textarea.is('[readonly]'));\n\n            // On submit or run/check, propagate the changes to textarea.\n            $('[type=submit], .qvpl-buttons button').click(function() {\n                // Cannot use aceEditor here, as it will have another value later.\n                $textarea.val(ace.edit('ace_placeholder_' + $textarea.attr('name')).getValue());\n            });\n        });\n\n        $(window).mousemove(function(event) {\n            if ($placeholderBeingResized) {\n                $placeholderBeingResized.height(function(i, height) {\n                    return height + event.clientY - prevY;\n                });\n                prevY = event.clientY;\n                ace.edit($placeholderBeingResized[0]).resize();\n                event.preventDefault();\n            }\n        }).mouseup(function() {\n            $placeholderBeingResized = null;\n        });\n\n        return aceEditor;\n    }\n\n    /**\n     * Loads Ace script from VPL plugin.\n     * @return {Promise} A promise that resolves upon load.\n     */\n    function loadAce() {\n        if (typeof ace !== 'undefined' && typeof aceTheme !== 'undefined') {\n            return $.Deferred().resolve();\n        }\n        var ACESCRIPTLOCATION = url.relativeUrl(\"/mod/vpl/editor/ace9\");\n        return $.when(\n            $.ajax({\n                url: ACESCRIPTLOCATION + '/ace.js',\n                dataType: 'script',\n                cache: true,\n                success: function() {\n                    ace.config.set('basePath', ACESCRIPTLOCATION);\n                }\n            }),\n            getEditorPreferences().then(function(prefs) {\n                aceTheme = prefs.aceTheme;\n                fontSize = prefs.fontSize;\n                return prefs;\n            }),\n        );\n    }\n\n    /**\n     * Get current preferences for font size and editor theme.\n     * @return {Promise} A promise that resolves upon load with an argument that is an object containing fontSize and aceTheme keys.\n     */\n    function getEditorPreferences() {\n        return $.ajax({\n            url: url.relativeUrl('/question/type/vplquestion/ajax/vplpreferences.json.php'),\n            cache: true,\n        }).promise().then(function(outcome) {\n            return {\n                aceTheme: outcome.success ? outcome.response.aceTheme : 'chrome',\n                fontSize: outcome.success ? Number(outcome.response.fontSize) : 12,\n            };\n        });\n    }\n\n    /**\n     * Save preferences for font size and editor theme.\n     * @param {String} aceTheme The new theme.\n     * @param {String|Number} fontSize The new font size.\n     */\n    function saveEditorPreferences(aceTheme, fontSize) {\n        $.ajax({\n            url: url.relativeUrl('/question/type/vplquestion/ajax/vplpreferences.json.php'),\n            cache: false,\n            method: 'POST',\n            data: {\n                set: {\n                    aceTheme: aceTheme,\n                    fontSize: Number(fontSize),\n                },\n                sesskey: cfg.sesskey,\n            },\n        });\n    }\n\n    return {\n        // Setup editors in question edition form.\n        setupFormEditors: function() {\n            return loadAce().done(function() {\n                setupAceEditors($('textarea[data-role=\"code-editor\"]'), '170px');\n            });\n        },\n\n        // Setup editor in answer form.\n        setupQuestionEditor: function($textarea, $setTextButtons, lineOffset) {\n            return loadAce().done(function() {\n                // Setup question editor.\n                var aceEditor = setupAceEditors($textarea, '200px', $textarea.data('templatelang'));\n                // Set first line number to match compilation messages.\n                aceEditor.setOption('firstLineNumber', lineOffset);\n                // Setup reset and correction buttons (if present, ie. not review mode).\n                $setTextButtons.each(function() {\n                    var text = $(this).data('text');\n                    $(this).removeAttr('data-text');\n                    $(this).click(function(event) {\n                        if (aceEditor.getValue() != text) {\n                            aceEditor.setValue(text);\n                        }\n                        event.preventDefault();\n                    });\n                });\n            });\n        },\n\n        getEditorPreferences: getEditorPreferences,\n\n        saveEditorPreferences: saveEditorPreferences,\n\n        changeFontSize: function(newFontSize) {\n            $('.ace-placeholder').each(function() {\n                ace.edit(this).setFontSize(Number(newFontSize));\n            });\n        },\n\n        changeTheme: function(newTheme) {\n            $('.ace-placeholder').each(function() {\n                ace.edit(this).setOptions({\n                    theme: 'ace/theme/' + newTheme\n                });\n            });\n        },\n    };\n});\n"],"names":["define","$","url","cfg","aceTheme","fontSize","setupAceEditors","$textareas","aceSize","aceLang","aceEditor","prevY","$placeholderBeingResized","undefined","each","$textarea","this","$editorPlaceholder","width","height","id","attr","class","insertAfter","hide","mousedown","event","clientY","preventDefault","ace","edit","setOptions","theme","mode","setFontSize","$blockScrolling","Infinity","getSession","setValue","val","setReadOnly","is","click","getValue","window","mousemove","i","resize","mouseup","loadAce","Deferred","resolve","ACESCRIPTLOCATION","relativeUrl","when","ajax","dataType","cache","success","config","set","getEditorPreferences","then","prefs","promise","outcome","response","Number","setupFormEditors","done","setupQuestionEditor","$setTextButtons","lineOffset","data","setOption","text","removeAttr","saveEditorPreferences","method","sesskey","changeFontSize","newFontSize","changeTheme","newTheme"],"mappings":";;;;;AAsBAA,OAAO,gCAAA,CAAC,SAAU,WAAY,gBAAgB,SAASC,EAAGC,IAAKC,KAG3D,IAAIC,SACAC,SAUJ,SAASC,gBAAgBC,WAAYC,QAASC,SAC1C,IAAIC,UAGAC,MACAC,yBAA2B,KAyD/B,YAvDgBC,IAAZJ,UACAA,QAAU,cAGdF,WAAWO,MAAK,WACZ,IAAIC,UAAYd,EAAEe,MACdC,mBAAqBhB,EAAE,QAAS,CAChCiB,MAAO,OACPC,OAAQX,QACRY,GAAM,mBAAqBL,UAAUM,KAAK,QAC1CC,MAAS,oBACVC,YAAYR,WACfA,UAAUS,OAEVvB,EAAE,QAAS,CACPmB,GAAM,cAAgBL,UAAUM,KAAK,QACrCC,MAAS,eACVC,YAAYN,oBACdQ,WAAU,SAASC,OAChBf,MAAQe,MAAMC,QACdf,yBAA2BK,mBAC3BS,MAAME,gBACV,KAGAlB,UAAYmB,IAAIC,KAAKb,mBAAmB,KAC9Bc,WAAW,CACjBC,MAAO,aAAe5B,SACtB6B,KAAM,YAAcxB,UAExBC,UAAUwB,YAAY7B,UACtBK,UAAUyB,gBAAkBC,IAC5B1B,UAAU2B,aAAaC,SAASvB,UAAUwB,OAC1C7B,UAAU8B,YAAYzB,UAAU0B,GAAG,eAGnCxC,EAAE,uCAAuCyC,OAAM,WAE3C3B,UAAUwB,IAAIV,IAAIC,KAAK,mBAAqBf,UAAUM,KAAK,SAASsB,WACxE,GACJ,IAEA1C,EAAE2C,QAAQC,WAAU,SAASnB,OACrBd,2BACAA,yBAAyBO,QAAO,SAAS2B,EAAG3B,QACxC,OAAOA,OAASO,MAAMC,QAAUhB,KACpC,IACAA,MAAQe,MAAMC,QACdE,IAAIC,KAAKlB,yBAAyB,IAAImC,SACtCrB,MAAME,iBAEd,IAAGoB,SAAQ,WACPpC,yBAA2B,IAC/B,IAEOF,SACX,CAMA,SAASuC,UACL,GAAmB,oBAARpB,UAA2C,IAAbzB,SACrC,OAAOH,EAAEiD,WAAWC,UAExB,IAAIC,kBAAoBlD,IAAImD,YAAY,wBACxC,OAAOpD,EAAEqD,KACLrD,EAAEsD,KAAK,CACHrD,IAAKkD,kBAAoB,UACzBI,SAAU,SACVC,OAAO,EACPC,QAAS,WACL7B,IAAI8B,OAAOC,IAAI,WAAYR,kBAC/B,IAEJS,uBAAuBC,MAAK,SAASC,OAGjC,OAFA3D,SAAW2D,MAAM3D,SACjBC,SAAW0D,MAAM1D,SACV0D,KACV,IAET,CAMA,SAASF,uBACL,OAAO5D,EAAEsD,KAAK,CACVrD,IAAKA,IAAImD,YAAY,2DACrBI,OAAO,IACRO,UAAUF,MAAK,SAASG,SACvB,MAAO,CACH7D,SAAU6D,QAAQP,QAAUO,QAAQC,SAAS9D,SAAW,SACxDC,SAAU4D,QAAQP,QAAUS,OAAOF,QAAQC,SAAS7D,UAAY,GAExE,GACJ,CAsBA,MAAO,CAEH+D,iBAAkB,WACd,OAAOnB,UAAUoB,MAAK,WAClB/D,gBAAgBL,EAAE,qCAAsC,QAC5D,GACH,EAGDqE,oBAAqB,SAASvD,UAAWwD,gBAAiBC,YACtD,OAAOvB,UAAUoB,MAAK,WAElB,IAAI3D,UAAYJ,gBAAgBS,UAAW,QAASA,UAAU0D,KAAK,iBAEnE/D,UAAUgE,UAAU,kBAAmBF,YAEvCD,gBAAgBzD,MAAK,WACjB,IAAI6D,KAAO1E,EAAEe,MAAMyD,KAAK,QACxBxE,EAAEe,MAAM4D,WAAW,aACnB3E,EAAEe,MAAM0B,OAAM,SAAShB,OACfhB,UAAUiC,YAAcgC,MACxBjE,UAAU4B,SAASqC,MAEvBjD,MAAME,gBACV,GACJ,GACJ,GACH,EAEDiC,qBAAsBA,qBAEtBgB,sBA9CJ,SAA+BzE,SAAUC,UACrCJ,EAAEsD,KAAK,CACHrD,IAAKA,IAAImD,YAAY,2DACrBI,OAAO,EACPqB,OAAQ,OACRL,KAAM,CACFb,IAAK,CACDxD,SAAUA,SACVC,SAAU8D,OAAO9D,WAErB0E,QAAS5E,IAAI4E,UAGzB,EAmCIC,eAAgB,SAASC,aACrBhF,EAAE,oBAAoBa,MAAK,WACvBe,IAAIC,KAAKd,MAAMkB,YAAYiC,OAAOc,aACtC,GACH,EAEDC,YAAa,SAASC,UAClBlF,EAAE,oBAAoBa,MAAK,WACvBe,IAAIC,KAAKd,MAAMe,WAAW,CACtBC,MAAO,aAAemD,UAE9B,GACJ,EAER"}