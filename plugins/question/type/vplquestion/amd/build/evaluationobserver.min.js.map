{"version":3,"file":"evaluationobserver.min.js","sources":["../src/evaluationobserver.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module checking the state of an evaluation task and updating the question feedback when it has been evaluated.\n * @copyright  2024 Astor Bizard\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/url', 'core/log'], function($, url, log) {\n\n    /**\n     * Check if evaluation is finished and update displayed message.\n     * @param {String} divid HTML id of question wrapping div.\n     * @param {String|Object} questiondata Data for checkevaluationstate.json.php.\n     */\n    function updateEvaluationState(divid, questiondata) {\n        $.ajax({\n            url: url.relativeUrl('/question/type/vplquestion/ajax/checkevaluationstate.json.php'),\n            data: questiondata,\n        })\n        .then(function(outcome) {\n            if (!outcome.success) {\n                throw new Error(outcome.error);\n            }\n\n            var $qdiv = $('#' + divid);\n\n            var response = outcome.response;\n            if (response.finished) {\n\n                // Update the question feedback.\n                $qdiv.find('.feedback, .im-feedback').remove();\n                $qdiv.find('.outcome').prepend(response.qfeedback + response.bfeedback);\n                $qdiv.append(response.javascript);\n                if ($qdiv.find('.outcome').html() == $qdiv.find('.outcome .accesshide')[0].outerHTML) {\n                    // No feedback: remove.\n                    $qdiv.find('.outcome').remove();\n                }\n\n                // Update the state and grade in the question info block.\n                $qdiv.find('.info .state').html(response.qinfo.state);\n                $qdiv.find('.info .grade').html(response.qinfo.grade);\n\n                // Update the navigation button color and title according to question state.\n                $('#' + response.navbutton.id)\n                .attr('title', response.navbutton.title)\n                .removeClass(response.navbutton.oldclass).addClass(response.navbutton.newclass);\n\n                // Add a message in the summary table if there is one, indicating that the overall quiz grade may have changed.\n                $('table.quizreviewsummary th').each(function() {\n                    if ($(this).text() == M.util.get_string('grade', 'quiz')) {\n                        if ($(this).next().find('[data-role=\"reload-page-message\"]').length == 0) {\n                            var message = M.util.get_string('gradehaschangedreload', 'qtype_vplquestion',\n                                    {aattr: 'href=\"#\" onclick=\"window.location.reload();return false;\"'});\n                            var icon = '<i class=\"fa fa-info-circle ml-2 mr-1 text-info\"></i>';\n                            $(this).next().append('<span data-role=\"reload-page-message\">' + icon + message + '</span>');\n                        }\n                    }\n                });\n\n                // Update step history with new state and new marks.\n                $qdiv.find('.history thead th').each(function(i) {\n                    if ($(this).text() == M.util.get_string('state', 'question')) {\n                        $qdiv.find('.history tbody tr.current td.c' + i).text(response.qinfo.state);\n                    } else if ($(this).text() == M.util.get_string('marks', 'question')) {\n                        $qdiv.find('.history tbody tr.current td.c' + i).text(response.qinfo.marks);\n                    }\n                });\n            } else {\n                $qdiv.find('[data-qtype_vplquestion-role=\"async-eval-info\"]').text(response.progressmessage);\n                setTimeout(function() {\n                    // Retry in 2 seconds.\n                    updateEvaluationState(divid, questiondata);\n                }, 2000);\n            }\n\n            return outcome;\n        })\n        .fail(log.error);\n    }\n\n    return {\n        init: updateEvaluationState,\n    };\n});\n"],"names":["define","$","url","log","init","updateEvaluationState","divid","questiondata","ajax","relativeUrl","data","then","outcome","success","Error","error","$qdiv","response","finished","find","remove","prepend","qfeedback","bfeedback","append","javascript","html","outerHTML","qinfo","state","grade","navbutton","id","attr","title","removeClass","oldclass","addClass","newclass","each","this","text","M","util","get_string","next","length","message","aattr","i","marks","progressmessage","setTimeout","fail"],"mappings":";;;;;AAoBAA,OAAO,uCAAA,CAAC,SAAU,WAAY,aAAa,SAASC,EAAGC,IAAKC,KAyExD,MAAO,CACHC,KAnEJ,SAASC,sBAAsBC,MAAOC,cAClCN,EAAEO,KAAK,CACHN,IAAKA,IAAIO,YAAY,iEACrBC,KAAMH,eAETI,MAAK,SAASC,SACX,IAAKA,QAAQC,QACT,MAAM,IAAIC,MAAMF,QAAQG,OAG5B,IAAIC,MAAQf,EAAE,IAAMK,OAEhBW,SAAWL,QAAQK,SAiDvB,OAhDIA,SAASC,UAGTF,MAAMG,KAAK,2BAA2BC,SACtCJ,MAAMG,KAAK,YAAYE,QAAQJ,SAASK,UAAYL,SAASM,WAC7DP,MAAMQ,OAAOP,SAASQ,YAClBT,MAAMG,KAAK,YAAYO,QAAUV,MAAMG,KAAK,wBAAwB,GAAGQ,WAEvEX,MAAMG,KAAK,YAAYC,SAI3BJ,MAAMG,KAAK,gBAAgBO,KAAKT,SAASW,MAAMC,OAC/Cb,MAAMG,KAAK,gBAAgBO,KAAKT,SAASW,MAAME,OAG/C7B,EAAE,IAAMgB,SAASc,UAAUC,IAC1BC,KAAK,QAAShB,SAASc,UAAUG,OACjCC,YAAYlB,SAASc,UAAUK,UAAUC,SAASpB,SAASc,UAAUO,UAGtErC,EAAE,8BAA8BsC,MAAK,WACjC,GAAItC,EAAEuC,MAAMC,QAAUC,EAAEC,KAAKC,WAAW,QAAS,SAC0B,GAAnE3C,EAAEuC,MAAMK,OAAO1B,KAAK,qCAAqC2B,OAAa,CACtE,IAAIC,QAAUL,EAAEC,KAAKC,WAAW,wBAAyB,oBACjD,CAACI,MAAO,8DAEhB/C,EAAEuC,MAAMK,OAAOrB,OAAO,8FAAkDuB,QAAU,UACtF,CAER,IAGA/B,MAAMG,KAAK,qBAAqBoB,MAAK,SAASU,GACtChD,EAAEuC,MAAMC,QAAUC,EAAEC,KAAKC,WAAW,QAAS,YAC7C5B,MAAMG,KAAK,iCAAmC8B,GAAGR,KAAKxB,SAASW,MAAMC,OAC9D5B,EAAEuC,MAAMC,QAAUC,EAAEC,KAAKC,WAAW,QAAS,aACpD5B,MAAMG,KAAK,iCAAmC8B,GAAGR,KAAKxB,SAASW,MAAMsB,MAE7E,MAEAlC,MAAMG,KAAK,mDAAmDsB,KAAKxB,SAASkC,iBAC5EC,YAAW,WAEP/C,sBAAsBC,MAAOC,aAChC,GAAE,MAGAK,OACV,IACAyC,KAAKlD,IAAIY,MACd,EAKJ"}