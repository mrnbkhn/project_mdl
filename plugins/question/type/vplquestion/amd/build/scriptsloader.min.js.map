{"version":3,"file":"scriptsloader.min.js","sources":["../src/scriptsloader.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides utility methods to load VPL scripts.\n * @copyright  Astor Bizard, 2019\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* globals VPL_Terminal */\n/* globals VPL_Util */\ndefine(['jquery', 'core/url', 'core/log'], function($, url, log) {\n\n    /**\n     * Constructor for a scripts loader.\n     * @param {String[]} scripts Array of scripts urls, to be loaded sequentially.\n     * @param {Boolean} alreadyDefined Whether the scripts are already loaded.\n     */\n    function Loader(scripts, alreadyDefined) {\n        this.loading = false;\n        this.loaded = alreadyDefined;\n        this.callbacks = [];\n        this.scripts = scripts;\n    }\n\n    // Loader for VPLUtil script for VPL pre 3.4.\n    // It beforehand loads VPL JQuery scripts.\n    var utilLoader = new Loader([\n        '/mod/vpl/editor/jquery/jquery-1.9.1.js',\n        '/mod/vpl/editor/jquery/jquery-ui-1.10.4.js',\n        '/mod/vpl/editor/VPL_jquery_no_conflict.js',\n        '/mod/vpl/editor/VPLUtil.js'],\n        typeof VPL_Util != 'undefined'); // eslint-disable-line camelcase\n\n    // Loader for VPLTerminal script for VPL pre 3.4.\n    // It beforehand loads XTerm script.\n    // Note: it needs VPLUtil to be loaded.\n    var terminalLoader = new Loader([\n        '/mod/vpl/editor/xterm/term.js',\n        '/mod/vpl/editor/VPLTerminal.js'],\n        typeof VPL_Terminal != 'undefined'); // eslint-disable-line camelcase\n\n    /**\n     * Load scripts according to given loader.\n     * It can be called multiple times but will only load them once.\n     * @param {Loader} loader The Loader from which to load scripts.\n     * @return {function} A function to be called with a callback as parameter.\n     */\n    function load(loader) {\n        return function(callback) {\n            if (loader.loaded) {\n                callback();\n                return;\n            }\n            loader.callbacks.push(callback);\n            if (loader.loading) {\n                return;\n            }\n            loader.loading = true;\n            /**\n             * Recursive function to load scripts sequentially.\n             * @param {Number} iscript Index of the script to load in the Loader array.\n             */\n            function loadNextScript(iscript) {\n                if (iscript < loader.scripts.length) {\n                    $.ajax({\n                        url: url.relativeUrl(loader.scripts[iscript]),\n                        dataType: 'script',\n                        cache: true\n                    })\n                    .then(function() {\n                        loadNextScript(iscript + 1);\n                        return;\n                    })\n                    .catch(log.error);\n                } else {\n                    loader.loaded = true;\n                    loader.callbacks.forEach(function(cb) {\n                        cb();\n                    });\n                }\n            }\n            loadNextScript(0);\n        };\n    }\n\n    /**\n     * Load VPLUtil and VPLUI scripts.\n     * This function loads either from the loader for VPL prior to 3.4.0, or from AMD module for VPL from 3.4.0 ongoing.\n     * @param {Number} vplVersion Version number of the VPL plugin.\n     * @param {function} callback A function to be called when VPLUtil is loaded and defined.\n     */\n    function loadVPLUtil(vplVersion, callback) {\n        if (typeof VPLUtil != 'undefined') {\n            callback();\n        } else {\n            var vpl34 = vplVersion >= 2021011014; // VPL version 3.4.0.\n            var vpl42 = vplVersion >= 2023072512; // VPL version 4.2.0.\n            if (vpl42) {\n                require(['mod_vpl/vplutil', 'mod_vpl/vplui'], function(VPLUtil, VPLUI) {\n                    window.VPLUtil = VPLUtil;\n                    window.VPLUI = VPLUI;\n                    callback();\n                });\n            } else if (vpl34) {\n                require(['mod_vpl/vplutil'], function(VPLUtil) {\n                    window.VPLUtil = VPLUtil;\n                    window.VPLUI = VPLUtil; // Just another pointer to VPLUtil.\n                    callback();\n                });\n            } else {\n                load(utilLoader)(function() {\n                    // eslint-disable-next-line camelcase\n                    window.VPLUtil = VPL_Util;\n                    // eslint-disable-next-line camelcase\n                    window.VPLUI = VPL_Util; // Just another pointer to VPLUtil.\n                    callback();\n                });\n            }\n        }\n    }\n\n    /**\n     * Load VPLTerminal script.\n     * This function loads either from the loader for VPL prior to 3.4.0, or from AMD module for VPL from 3.4.0 ongoing.\n     * @param {Number} vplVersion Version number of the VPL plugin.\n     * @param {function} callback A function to be called when VPLUtil is loaded and defined.\n     */\n    function loadVPLTerminal(vplVersion, callback) {\n        if (typeof VPLTerminal != 'undefined') {\n            callback();\n        } else {\n            var vpl34 = vplVersion >= 2021011014; // VPL version 3.4.0.\n            if (vpl34) {\n                loadVPLUtil(vplVersion, function() {\n                    require(['mod_vpl/vplterminal'], function(VPLTerminal) {\n                        window.VPLTerminal = VPLTerminal;\n                        $.ajax({\n                            url: url.relativeUrl('/mod/vpl/editor/xterm/term.js'),\n                            dataType: 'script',\n                            cache: true\n                        }).done(callback);\n                    });\n                });\n            } else {\n                loadVPLUtil(vplVersion, function() {\n                    load(terminalLoader)(function() {\n                        window.VPLTerminal = VPL_Terminal; // eslint-disable-line camelcase\n                        callback();\n                    });\n                });\n            }\n        }\n    }\n\n    return {\n        loadVPLUtil: loadVPLUtil,\n        loadVPLTerminal: loadVPLTerminal\n    };\n});\n"],"names":["define","$","url","log","Loader","scripts","alreadyDefined","this","loading","loaded","callbacks","utilLoader","VPL_Util","terminalLoader","VPL_Terminal","load","loader","callback","push","loadNextScript","iscript","length","ajax","relativeUrl","dataType","cache","then","catch","error","forEach","cb","loadVPLUtil","vplVersion","VPLUtil","vpl34","require","VPLUI","window","loadVPLTerminal","VPLTerminal","done"],"mappings":";;;;;AAuBAA,OAAO,kCAAA,CAAC,SAAU,WAAY,aAAa,SAASC,EAAGC,IAAKC,KAOxD,SAASC,OAAOC,QAASC,gBACrBC,KAAKC,SAAU,EACfD,KAAKE,OAASH,eACdC,KAAKG,UAAY,GACjBH,KAAKF,QAAUA,OACnB,CAIA,IAAIM,WAAa,IAAIP,OAAO,CACxB,yCACA,6CACA,4CACA,8BACmB,oBAAZQ,UAKPC,eAAiB,IAAIT,OAAO,CAC5B,gCACA,kCACuB,oBAAhBU,cAQX,SAASC,KAAKC,QACV,OAAO,SAASC,UACRD,OAAOP,OACPQ,YAGJD,OAAON,UAAUQ,KAAKD,UAClBD,OAAOR,UAGXQ,OAAOR,SAAU,EAKjB,SAASW,eAAeC,SAChBA,QAAUJ,OAAOX,QAAQgB,OACzBpB,EAAEqB,KAAK,CACHpB,IAAKA,IAAIqB,YAAYP,OAAOX,QAAQe,UACpCI,SAAU,SACVC,OAAO,IAEVC,MAAK,WACFP,eAAeC,QAAU,EAE5B,IACAO,MAAMxB,IAAIyB,QAEXZ,OAAOP,QAAS,EAChBO,OAAON,UAAUmB,SAAQ,SAASC,IAC9BA,IACJ,IAER,CACAX,CAAe,KAEvB,CAQA,SAASY,YAAYC,WAAYf,UAC7B,GAAsB,oBAAXgB,QACPhB,eACG,CACH,IAAIiB,MAAQF,YAAc,WACdA,YAAc,WAEtBG,QAAQ,CAAC,kBAAmB,kBAAkB,SAASF,QAASG,OAC5DC,OAAOJ,QAAUA,QACjBI,OAAOD,MAAQA,MACfnB,UACJ,IACOiB,MACPC,QAAQ,CAAC,oBAAoB,SAASF,SAClCI,OAAOJ,QAAUA,QACjBI,OAAOD,MAAQH,QACfhB,UACJ,IAEAF,KAAKJ,WAALI,EAAiB,WAEbsB,OAAOJ,QAAUrB,SAEjByB,OAAOD,MAAQxB,SACfK,UACJ,GAER,CACJ,CAmCA,MAAO,CACHc,YAAaA,YACbO,gBA7BJ,SAAyBN,WAAYf,UACP,oBAAfsB,YACPtB,WAIIc,YAAYC,WAFJA,YAAc,WAEE,WACpBG,QAAQ,CAAC,wBAAwB,SAASI,aACtCF,OAAOE,YAAcA,YACrBtC,EAAEqB,KAAK,CACHpB,IAAKA,IAAIqB,YAAY,iCACrBC,SAAU,SACVC,OAAO,IACRe,KAAKvB,SACZ,GACJ,EAEwB,WACpBF,KAAKF,eAALE,EAAqB,WACjBsB,OAAOE,YAAczB,aACrBG,UACJ,GACJ,EAGZ,EAMJ"}